<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti√≥n de Materiales - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}"/>
</head>
<body th:replace="~{fragments/admin-layout :: layout(~{::main})}">
<main>
<main>
  <!-- Breadcrumbs -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
    <th:block th:replace="~{fragments/components/breadcrumbs :: auto}"></th:block>
  </div>

  <!-- Messages -->
  <div th:if="${successMessage}" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
    <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg">
      <div class="flex items-center">
        <i class="fa-solid fa-circle-check mr-2 text-base"></i>
        <span th:text="${successMessage}"></span>
      </div>
    </div>
  </div>

  <div th:if="${errorMessage}" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
    <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg">
      <div class="flex items-center">
        <i class="fa-solid fa-circle-exclamation mr-2 text-base"></i>
        <span th:text="${errorMessage}"></span>
      </div>
    </div>
  </div>

  <!-- Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

    <!-- LISTA DE MATERIALES -->
    <div th:if="${viewType == 'list'}" class="bg-white rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200 space-y-3">
        <h2 class="text-lg font-semibold text-gray-900">
          Gesti√≥n de Materiales
        </h2>
        <p class="text-sm text-gray-600">
          Gestiona el cat√°logo de materiales reciclables disponibles en el sistema. Puedes crear nuevos materiales, editar informaci√≥n existente y gestionar el estado de cada material. Los materiales activos estar√°n disponibles para las solicitudes de recolecci√≥n.
          <span class="block mt-1 text-xs text-gray-500">
            Usa el buscador para filtrar por nombre, descripci√≥n o categor√≠a. Los materiales marcados como inactivos no estar√°n disponibles para nuevas solicitudes.
          </span>
        </p>
        <h3 class="text-lg font-semibold text-gray-900">
          Lista de Materiales (<span th:text="${totalMaterials}">0</span>)
        </h3>
        <!-- Buscador -->
        <form method="get" action="/admin/materials" class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 w-full">
          <input type="text" name="q" th:value="${query}" placeholder="Buscar por nombre, descripci√≥n o categor√≠a"
                 class="w-full sm:w-96 h-9 px-3 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"/>
          <div class="flex gap-2">
            <button type="submit" class="h-9 px-3 text-sm bg-emerald-600 text-white rounded-md hover:bg-emerald-700">Buscar</button>
            <a href="/admin/materials" class="h-9 px-3 text-sm border border-gray-300 rounded-md hover:bg-gray-50 flex items-center">Limpiar</a>
          </div>
        </form>
        <!-- (Bot√≥n se muestra al final de la lista) -->
      </div>

      <div class="overflow-x-auto px-6 py-4">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Material</th>
              <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Categor√≠a</th>
              <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Estado</th>
              <th class="px-4 py-2 text-left text-sm font-medium text-gray-700 hidden md:table-cell">Descripci√≥n</th>
              <th class="px-4 py-2 text-right text-sm font-medium text-gray-700">Acciones</th>
            </tr>
          </thead>
          <tbody id="materialsTableBody" class="bg-white divide-y divide-gray-200">
            <tr th:each="material : ${materials}" class="hover:bg-gray-50 odd:bg-gray-50">
              <td class="px-4 py-2 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-10 w-10">
                    <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                      <span class="text-sm font-medium text-blue-800" th:text="${#strings.substring(material.name, 0, 1).toUpperCase()}">M</span>
                    </div>
                  </div>
                  <div class="ml-4">
                    <div class="text-sm font-medium text-gray-900" th:text="${material.name}">Nombre</div>
                    <div class="text-xs text-gray-500" th:text="'ID: ' + ${material.id}">ID</div>
                  </div>
                </div>
              </td>
              <td class="px-4 py-2 whitespace-nowrap">
                <span th:if="${material.category}" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                  üìÅ <span th:text="${material.category}">Categor√≠a</span>
                </span>
                <span th:unless="${material.category}" class="text-xs text-gray-500">Sin categor√≠a</span>
              </td>
              <td class="px-4 py-2 whitespace-nowrap">
                <span th:class="${material.active} ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                      class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                  <span th:text="${material.active} ? '‚úÖ Activo' : '‚ùå Inactivo'">Estado</span>
                </span>
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 hidden md:table-cell max-w-[200px] truncate"
                  th:attr="title=${material.description}"
                  th:text="${material.description}">Descripci√≥n</td>
              <td class="px-4 py-2 whitespace-nowrap text-right text-sm font-medium">
                <div class="flex justify-end gap-2">
                  <a th:href="@{/admin/materials(action='edit', id=${material.id})}"
                     class="h-9 px-3 text-sm rounded border hover:bg-gray-50 text-green-700 border-green-200 flex items-center">Editar</a>
                  <button onclick="confirmDelete(this)" th:data-id="${material.id}" th:data-name="${material.name}"
                          class="h-9 px-3 text-sm rounded border hover:bg-gray-50 text-red-700 border-red-200 flex items-center">Eliminar</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div th:if="${totalMaterials == 0}" class="px-6 py-8 text-center text-gray-500">
        <div class="flex flex-col items-center">
          <i class="fa-solid fa-box-open text-4xl text-gray-300 mb-4"></i>
          <p>No hay materiales para mostrar.</p>
        </div>
      </div>

      <!-- Controles de paginaci√≥n -->
      <div class="px-6 py-4 border-t border-gray-200 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div class="flex items-center gap-2 text-sm text-gray-600">
          <span>Filas por p√°gina:</span>
          <select id="materialsPageSize" class="border border-gray-300 rounded-md px-2 py-1 focus:outline-none focus:ring-2 focus:ring-green-500">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <span id="materialsPageInfo" class="ml-2">Mostrando 0‚Äì0 de 0</span>
        </div>
        <div id="materialsPaginationControls" class="flex items-center gap-1"></div>
      </div>

      <!-- Bot√≥n 'Nuevo Material' (al final de la lista) -->
      <div class="px-6 pb-4 flex justify-start">
        <a href="?action=new" class="bg-green-600 text-white px-3 py-1.5 rounded-md hover:bg-green-700 flex items-center space-x-2 text-sm">
          <i class="fa-solid fa-plus text-xs" aria-hidden="true"></i>
          <span>Nuevo Material</span>
        </a>
      </div>
    </div>

  <!-- Form View -->
  <div th:if="${viewType == 'form'}" class="bg-white rounded-lg shadow">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900" th:text="${isEdit} ? 'Editar Material' : 'Nuevo Material'">Nuevo Material</h2>
    </div>

    <form th:action="@{/admin/materials}" method="post" th:object="${material}" class="px-6 py-3 space-y-3 form-compact">
      <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
      <input type="hidden" th:field="*{id}" />

      <button type="button"
              class="px-3 py-1.5 text-sm rounded-md border border-gray-300 hover:bg-gray-50"
              hx-get="/admin/materials/form-demo"
              hx-target="#material-form-fields"
              hx-swap="outerHTML">
        Completar campos
      </button>

      <div id="material-form-fields" th:fragment="materialFormFields" th:object="${material}" class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <!-- Nombre -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Nombre *</label>
          <input type="text" th:field="*{name}" required
                 class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>

        <!-- Categor√≠a -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Categor√≠a</label>
          <input type="text" th:field="*{category}"
                 class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                 placeholder="ej: Pl√°sticos, Papel, Vidrio">
        </div>

        <!-- Descripci√≥n -->
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n</label>
          <textarea th:field="*{description}" rows="3"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                    placeholder="Describe las caracter√≠sticas del material..."></textarea>
        </div>

        <!-- Estado Activo -->
        <div class="flex items-center">
          <input type="checkbox" th:field="*{active}" id="active"
                 class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
          <label for="active" class="ml-2 block text-sm text-gray-700">Material Activo</label>
        </div>
      </div>

      <div class="flex justify-end gap-2 pt-2 border-t border-gray-200">
        <a href="/admin/materials" class="px-3 py-1.5 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 text-sm">
          Cancelar
        </a>
        <button type="submit" class="px-3 py-1.5 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm">
          <span th:text="${isEdit} ? 'Actualizar' : 'Crear'">Crear</span>
        </button>
      </div>
    </form>

    <style>
      /* Compactar campos del formulario para alinear con la lista */
      .form-compact input[type="text"],
      .form-compact input[type="email"],
      .form-compact input[type="number"],
      .form-compact input[type="url"],
      .form-compact input[type="password"],
      .form-compact select,
      .form-compact textarea {
        padding-top: 0.25rem; /* py-1 */
        padding-bottom: 0.25rem;
        font-size: 0.875rem; /* text-sm */
      }
      .form-compact label { margin-bottom: 0.25rem; } /* mb-1 */
    </style>
  </div>
  </div>
</main>
</body>
</html>
<script>
  // Inicializar Lucide icons (ya est√°n globales en admin layout)

  // Delete confirmation
  function confirmDelete(button) {
    const materialId = button.getAttribute('data-id');
    const materialName = button.getAttribute('data-name');

    // Actualizar el nombre del material en el modal
    document.getElementById('deleteMaterialName').textContent = materialName;

    // Configurar la acci√≥n del formulario
    const deleteForm = document.getElementById('deleteForm');
    deleteForm.action = '/admin/materials/delete/' + materialId;

    // Mostrar el modal
    document.getElementById('deleteModal').classList.remove('hidden');
  }

  function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
  }

  // Close modal on outside click
  document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeDeleteModal();
    }
  });

  // ================== Paginaci√≥n Front-End ==================
  (function() {
    const tbody = document.getElementById('materialsTableBody');
    if (!tbody) return;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const pageSizeSelect = document.getElementById('materialsPageSize');
    const pageInfo = document.getElementById('materialsPageInfo');
    const controls = document.getElementById('materialsPaginationControls');

    // Configuraci√≥n inicial
    let pageSize = parseInt(localStorage.getItem('materials_page_size') || '10', 10);
    if (![10,25,50,100].includes(pageSize)) pageSize = 10;
    pageSizeSelect.value = String(pageSize);
    let currentPage = 1; // 1-indexed

    function renderPage() {
      const total = rows.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;
      const startIdx = (currentPage - 1) * pageSize;
      const endIdx = Math.min(startIdx + pageSize, total);

      // Mostrar/ocultar filas
      rows.forEach((tr, idx) => {
        tr.style.display = (idx >= startIdx && idx < endIdx) ? '' : 'none';
      });

      // Info
      if (total === 0) {
        pageInfo.textContent = 'Mostrando 0‚Äì0 de 0';
      } else {
        pageInfo.textContent = `Mostrando ${startIdx + 1}‚Äì${endIdx} de ${total}`;
      }

      // Controles
      buildControls(totalPages);
    }

    function buildControls(totalPages) {
      controls.innerHTML = '';
      const btnClass = 'px-3 py-1 border rounded-md text-sm hover:bg-gray-50';
      const activeClass = 'bg-green-600 text-white border-green-600 hover:bg-green-700';

      function addButton(label, disabled, onClick, extraClass = '') {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = label;
        btn.className = `${btnClass} ${extraClass}`;
        btn.disabled = disabled;
        btn.onclick = onClick;
        controls.appendChild(btn);
      }

      addButton('¬´', currentPage === 1, () => { currentPage = 1; renderPage(); });
      addButton('‚Äπ', currentPage === 1, () => { currentPage--; renderPage(); });

      // P√°ginas (m√°x 7 botones visibles)
      const maxBtns = 7;
      let start = Math.max(1, currentPage - Math.floor(maxBtns/2));
      let end = Math.min(totalPages, start + maxBtns - 1);
      if (end - start + 1 < maxBtns) {
        start = Math.max(1, end - maxBtns + 1);
      }
      for (let p = start; p <= end; p++) {
        addButton(String(p), false, () => { currentPage = p; renderPage(); }, p === currentPage ? activeClass : '');
      }

      addButton('‚Ä∫', currentPage === totalPages, () => { currentPage++; renderPage(); });
      addButton('¬ª', currentPage === totalPages, () => { currentPage = totalPages; renderPage(); });
    }

    pageSizeSelect.addEventListener('change', () => {
      pageSize = parseInt(pageSizeSelect.value, 10);
      localStorage.setItem('materials_page_size', String(pageSize));
      currentPage = 1;
      renderPage();
    });

    // Render inicial
    renderPage();
  })();
</script>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg max-w-md w-full">
      <div class="p-6">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <i class="fa-solid fa-triangle-exclamation text-red-600 text-lg"></i>
          </div>
          <div class="ml-3">
            <h3 class="text-lg font-medium text-gray-900">Confirmar Eliminaci√≥n</h3>
            <p class="mt-2 text-sm text-gray-500">
              ¬øEst√°s seguro de que deseas eliminar el material <strong id="deleteMaterialName"></strong>?
              Esta acci√≥n no se puede deshacer.
            </p>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-6 py-3 flex justify-end space-x-3">
        <button onclick="closeDeleteModal()"
                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
          Cancelar
        </button>
        <form id="deleteForm" method="post" class="inline">
          <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
          <button type="submit"
                  class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
            Eliminar
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

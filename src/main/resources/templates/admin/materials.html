<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Materiales - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}"/>
</head>
<body th:replace="~{fragments/admin-layout :: layout(~{::main})}">
<main>
  <!-- Header -->
  <div class="bg-gray-50 px-4 py-5 border-b border-gray-200 sm:px-6">
    <div class="-ml-4 -mt-2 flex items-center justify-between flex-wrap sm:flex-nowrap">
      <div class="ml-4 mt-2">
        <h3 class="text-2xl font-bold leading-6 text-gray-900">Gestión de Materiales</h3>
        <p class="mt-1 text-sm text-gray-500">
          Total: <span th:text="${totalMaterials}">0</span> materiales
        </p>
      </div>
      <div class="ml-4 mt-2 flex-shrink-0" th:if="${viewType == 'list'}">
        <a href="?action=new" class="relative inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
          Nuevo Material
        </a>
      </div>
    </div>
  </div>

  <!-- Breadcrumbs -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
    <th:block th:with="
                  bcItems=${
                    viewType == 'form' ? 
                      #lists.list({'label':'Dashboard','url':@{/admin/dashboard}},
                                 {'label':'Materiales','url':@{/admin/materials}},
                                 {'label': (isEdit ? 'Editar' : 'Alta'), 'url': null}) :
                      (viewType == 'view' ?
                        #lists.list({'label':'Dashboard','url':@{/admin/dashboard}},
                                   {'label':'Materiales','url':@{/admin/materials}},
                                   {'label':'Detalle','url': null}) :
                        #lists.list({'label':'Dashboard','url':@{/admin/dashboard}},
                                   {'label':'Materiales','url':@{/admin/materials}})
                      )
                  }
                "
              th:replace="~{fragments/components/breadcrumbs :: breadcrumbs(${bcItems}, 'Gestión de Materiales')}">
    </th:block>
  </div>

  <!-- Success/Error Messages -->
  <div th:if="${successMessage}" class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded relative mx-4 mt-4">
    <span th:text="${successMessage}"></span>
  </div>
  <div th:if="${errorMessage}" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded relative mx-4 mt-4">
    <span th:text="${errorMessage}"></span>
  </div>

  <!-- List View -->
  <div th:if="${viewType == 'list'}" class="px-4 py-6">
    <!-- Search Bar -->
    <form method="get" action="/admin/materials" class="mb-4 flex items-center gap-2">
      <input type="text" name="q" th:value="${query}" placeholder="Buscar por nombre, descripción o categoría" class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-blue-500" />
      <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Buscar</button>
      <a href="/admin/materials" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200">Limpiar</a>
    </form>
    <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
          </tr>
        </thead>
        <tbody id="materialsTableBody" class="bg-white divide-y divide-gray-200">
          <tr th:each="material : ${materials}" class="hover:bg-gray-50 odd:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" th:text="${material.id}"></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" th:text="${material.name}"></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${material.category}"></td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span th:if="${material.active}" class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Activo</span>
              <span th:unless="${material.active}" class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Inactivo</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <a th:href="@{/admin/materials(action='edit', id=${material.id})}" class="text-blue-600 hover:text-blue-900 mr-3">Editar</a>
              <form th:action="@{/admin/materials/delete/{id}(id=${material.id})}" method="post" class="inline" onsubmit="return confirm('¿Estás seguro?')">
                <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
                <button type="submit" class="text-red-600 hover:text-red-900">Eliminar</button>
              </form>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div th:if="${totalMaterials == 0}" class="px-4 py-6 text-gray-500">No hay materiales para mostrar.</div>
    <!-- Controles de paginación (Front-end) -->
    <div class="px-4 py-4 border-t border-gray-200 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div class="flex items-center gap-2 text-sm text-gray-600">
        <span>Filas por página:</span>
        <select id="materialsPageSize" class="border border-gray-300 rounded-md px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
        <span id="materialsPageInfo" class="ml-2">Mostrando 0–0 de 0</span>
      </div>
      <div id="materialsPaginationControls" class="flex items-center gap-1"></div>
    </div>
  </div>

  <!-- Form View -->
  <div th:if="${viewType == 'form'}" class="px-4 py-6">
    <div class="max-w-2xl mx-auto">
      <form th:action="@{/admin/materials}" method="post" th:object="${material}" class="space-y-6">
        <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
        <input type="hidden" th:field="*{id}" />
        
        <!-- HTMX fragment container for form fields -->
        <div id="material-form-fields" th:fragment="materialFormFields" th:object="${material}">
          <div>
            <label for="name" class="block text-sm font-medium text-gray-700">Nombre</label>
            <input type="text" th:field="*{name}" id="name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required />
          </div>

          <div>
            <label for="description" class="block text-sm font-medium text-gray-700">Descripción</label>
            <textarea th:field="*{description}" id="description" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
          </div>

          <div>
            <label for="category" class="block text-sm font-medium text-gray-700">Categoría</label>
            <input type="text" th:field="*{category}" id="category" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" />
          </div>

          <div class="flex items-center">
            <input type="checkbox" th:field="*{active}" id="active" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" />
            <label for="active" class="ml-2 block text-sm text-gray-900">Activo</label>
          </div>
        </div>

        <div class="flex justify-end space-x-3">
          <button type="button"
                  class="bg-indigo-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-indigo-700"
                  hx-get="/admin/materials/form-demo"
                  hx-target="#material-form-fields"
                  hx-swap="outerHTML">
            Completar campos
          </button>
          <button type="submit" formmethod="post" th:formaction="@{/admin/materials/form-demo}"
                  class="bg-emerald-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-emerald-700">
            Crear demo
          </button>
          <a href="/admin/materials" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">
            Cancelar
          </a>
          <button type="submit" class="bg-blue-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700">
            <span th:if="${isEdit}">Actualizar</span>
            <span th:unless="${isEdit}">Crear</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</main>
</body>
</html>
<script>
  (function() {
    const tbody = document.getElementById('materialsTableBody');
    if (!tbody) return;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const pageSizeSelect = document.getElementById('materialsPageSize');
    const pageInfo = document.getElementById('materialsPageInfo');
    const controls = document.getElementById('materialsPaginationControls');

    let pageSize = parseInt(localStorage.getItem('materials_page_size') || '10', 10);
    if (![10,25,50,100].includes(pageSize)) pageSize = 10;
    pageSizeSelect.value = String(pageSize);
    let currentPage = 1;

    function renderPage() {
      const total = rows.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;
      const startIdx = (currentPage - 1) * pageSize;
      const endIdx = Math.min(startIdx + pageSize, total);

      rows.forEach((tr, idx) => {
        tr.style.display = (idx >= startIdx && idx < endIdx) ? '' : 'none';
      });

      if (total === 0) {
        pageInfo.textContent = 'Mostrando 0–0 de 0';
      } else {
        pageInfo.textContent = `Mostrando ${startIdx + 1}–${endIdx} de ${total}`;
      }

      buildControls(totalPages);
    }

    function buildControls(totalPages) {
      controls.innerHTML = '';
      const btnClass = 'px-3 py-1 border rounded-md text-sm hover:bg-gray-50';
      const activeClass = 'bg-blue-600 text-white border-blue-600 hover:bg-blue-700';

      function addButton(label, disabled, onClick, extraClass = '') {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = label;
        btn.className = `${btnClass} ${extraClass}`;
        btn.disabled = disabled;
        btn.onclick = onClick;
        controls.appendChild(btn);
      }

      addButton('«', currentPage === 1, () => { currentPage = 1; renderPage(); });
      addButton('‹', currentPage === 1, () => { currentPage--; renderPage(); });

      const maxBtns = 7;
      let start = Math.max(1, currentPage - Math.floor(maxBtns/2));
      let end = Math.min(totalPages, start + maxBtns - 1);
      if (end - start + 1 < maxBtns) {
        start = Math.max(1, end - maxBtns + 1);
      }
      for (let p = start; p <= end; p++) {
        addButton(String(p), false, () => { currentPage = p; renderPage(); }, p === currentPage ? activeClass : '');
      }

      addButton('›', currentPage === totalPages, () => { currentPage++; renderPage(); });
      addButton('»', currentPage === totalPages, () => { currentPage = totalPages; renderPage(); });
    }

    pageSizeSelect.addEventListener('change', () => {
      pageSize = parseInt(pageSizeSelect.value, 10);
      localStorage.setItem('materials_page_size', String(pageSize));
      currentPage = 1;
      renderPage();
    });

    renderPage();
  })();
</script>

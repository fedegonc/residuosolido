<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti√≥n de Solicitudes - Admin</title>
  <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
 </head>
 <body th:replace="~{fragments/admin-layout :: layout(~{::main})}">
 <main>
  <!-- Breadcrumbs -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
    <th:block th:with="
                  bcItems=${
                    viewType == 'form' ? 
                      #lists.list({'label':'Dashboard','url':@{/admin/dashboard}},
                                 {'label':'Solicitudes','url':@{/admin/requests}},
                                 {'label':'Gestionar', 'url': null}) :
                      #lists.list({'label':'Dashboard','url':@{/admin/dashboard}},
                                 {'label':'Solicitudes','url':@{/admin/requests}})
                  }
                "
              th:replace="~{fragments/components/breadcrumbs :: breadcrumbs(${bcItems}, 'Gesti√≥n de Solicitudes')}">
    </th:block>
  </div>

  <!-- Messages -->
  <div th:if="${successMessage}" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
    <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg">
      <div class="flex items-center">
        <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>
        <span th:text="${successMessage}"></span>
      </div>
    </div>
  </div>

  <div th:if="${errorMessage}" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
    <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg">
      <div class="flex items-center">
        <i data-lucide="alert-circle" class="w-5 h-5 mr-2"></i>
        <span th:text="${errorMessage}"></span>
      </div>
    </div>
  </div>

  <!-- Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

    <!-- LISTA DE SOLICITUDES -->
    <div th:if="${viewType == 'list'}" class="bg-white rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200 space-y-3">
        <h2 class="text-lg font-semibold text-gray-900">
          Gesti√≥n de Solicitudes
        </h2>
        <p class="text-sm text-gray-600">
          Gestiona todas las solicitudes de recolecci√≥n de residuos en el sistema. Puedes ver detalles de cada solicitud, cambiar su estado, programar fechas de recolecci√≥n y gestionar su ciclo de vida completo desde creaci√≥n hasta finalizaci√≥n.
          <span class="block mt-1 text-xs text-gray-500">
            Usa el buscador para filtrar por usuario, materiales, direcci√≥n, estado o fecha. Las solicitudes pendientes requieren atenci√≥n inmediata para su asignaci√≥n.
          </span>
        </p>
        <h3 class="text-lg font-semibold text-gray-900">
          Solicitudes de recolecci√≥n (<span th:text="${totalRequests}">0</span>)
        </h3>
        <!-- Buscador -->
        <form th:action="@{/admin/requests}" method="get" class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 w-full">
          <input type="text" name="q" th:value="${query}" placeholder="Buscar por usuario, materiales, direcci√≥n, estado o fecha..."
                 class="w-full sm:w-96 h-9 px-3 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"/>
          <div class="flex gap-2">
            <button type="submit" class="h-9 px-3 text-sm bg-emerald-600 text-white rounded-md hover:bg-emerald-700">Buscar</button>
            <a th:href="@{/admin/requests}" class="h-9 px-3 text-sm border border-gray-300 rounded-md hover:bg-gray-50 flex items-center">Limpiar</a>
          </div>
        </form>
      </div>

      <div class="overflow-x-auto px-6 py-4">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Organizaci√≥n</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materiales</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Prog.</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Creado</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody id="requestsTableBody" class="bg-white divide-y divide-gray-200">
            <tr th:each="request : ${requests}" class="hover:bg-gray-50 odd:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="h-10 w-10 rounded bg-gray-100 flex items-center justify-center overflow-hidden">
                    <img th:if="${request.imageUrl != null and !#strings.isEmpty(request.imageUrl) and request.imageUrl != '/images/placeholder.jpg'}"
                         th:src="${request.imageUrl}"
                         alt="Request image"
                         class="h-10 w-10 object-cover rounded">
                    <i th:unless="${request.imageUrl != null and !#strings.isEmpty(request.imageUrl) and request.imageUrl != '/images/placeholder.jpg'}"
                       class="fa-solid fa-file-text text-blue-600 text-sm"></i>
                  </div>
                  <div class="ml-4">
                    <div class="text-sm font-medium text-gray-900" th:text="${request.user != null ? request.user.username : 'Sin usuario'}">usuario</div>
                    <div class="text-xs text-gray-500" th:text="${request.collectionAddress}">direcci√≥n</div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div th:if="${request.organization != null}" class="flex items-center">
                  <i data-lucide="building-2" class="w-4 h-4 mr-2 text-emerald-600"></i>
                  <div>
                    <div class="text-sm font-medium text-gray-900" th:text="${request.organization.fullName != null ? request.organization.fullName : request.organization.username}">Organizaci√≥n</div>
                    <div class="text-xs text-gray-500">Asignada</div>
                  </div>
                </div>
                <div th:unless="${request.organization != null}" class="text-sm text-gray-400 italic">
                  Sin asignar
                </div>
              </td>
              <td class="px-6 py-4 text-sm text-gray-700 max-w-xs">
                <div class="truncate" th:text="${request.materialsAsString}">materiales</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${request.scheduledDate != null ? #temporals.format(request.scheduledDate, 'dd/MM/yyyy') : 'No programada'}">fecha</td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span th:class="${request.status.name() == 'PENDING'} ? 'bg-yellow-100 text-yellow-800' : 
                               (${request.status.name() == 'ACCEPTED'} ? 'bg-blue-100 text-blue-800' : 
                               (${request.status.name() == 'COMPLETED'} ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'))"
                      class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                  <span th:switch="${request.status.name()}">
                    <span th:case="'PENDING'">‚è≥ Pendiente</span>
                    <span th:case="'ACCEPTED'">‚úÖ Aceptada</span>
                    <span th:case="'COMPLETED'">üéâ Completada</span>
                    <span th:case="*">‚ùå Rechazada</span>
                  </span>
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${#temporals.format(request.createdAt, 'dd/MM/yyyy')}">creado</td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <div class="flex justify-end space-x-2">
                  <a th:href="@{/admin/requests(action='edit', id=${request.id})}" class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded hover:bg-green-200">Gestionar</a>
                  <button onclick="confirmDelete(this)" th:data-id="${request.id}" th:data-name="${request.user?.username}" class="px-2 py-1 text-xs bg-red-100 text-red-800 rounded hover:bg-red-200">Eliminar</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- Paginaci√≥n front-end -->
      <div class="px-6 py-4 border-t border-gray-200 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div class="flex items-center gap-2 text-sm text-gray-600">
          <span>Filas por p√°gina:</span>
          <select id="requestsPageSize" class="border border-gray-300 rounded-md px-2 py-1 focus:outline-none focus:ring-2 focus:ring-green-500">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <span id="requestsPageInfo" class="ml-2">Mostrando 0‚Äì0 de 0</span>
        </div>
        <div id="requestsPaginationControls" class="flex items-center gap-1"></div>
      </div>
      <!-- Bot√≥n 'Nueva Solicitud' (opcional, mismo lugar que 'Alta de usuario') -->
      <div class="px-6 pb-4 flex justify-start">
        <a th:if="${showCreateButton}" th:href="@{/admin/requests(action='new')}"
           class="bg-green-600 text-white px-3 py-1.5 rounded-md hover:bg-green-700 flex items-center space-x-2 text-sm">
          <i data-lucide="plus" class="w-4 h-4"></i>
          <span>Nueva Solicitud</span>
        </a>
      </div>
    </div>

    <!-- FORMULARIO SOLICITUD -->
    <div th:if="${viewType == 'form'}" class="bg-white rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900" th:text="${isCreate} ? 'Nueva Solicitud' : 'Gestionar Solicitud'">Gestionar Solicitud</h2>
      </div>

      <form th:action="@{/admin/requests}" method="post" th:object="${request}" class="p-6 space-y-6">
        <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
        <input type="hidden" th:field="*{id}" />

        <!-- Botones HTMX para completar o crear demo -->
        <div class="flex justify-end gap-2">
          <button type="button"
                  class="px-3 py-1.5 text-sm rounded-md border border-gray-300 hover:bg-gray-50"
                  hx-get="/admin/requests/form-demo"
                  hx-target="#request-form-fields"
                  hx-swap="outerHTML">
            Completar campos
          </button>
          <button type="submit" formmethod="post" th:formaction="@{/admin/requests/form-demo}"
                  class="px-3 py-1.5 text-sm bg-emerald-600 text-white rounded-md hover:bg-emerald-700">
            Crear demo
          </button>
        </div>

        <!-- Fragmento con campos del formulario (din√°mico para HTMX) -->
        <div id="request-form-fields" th:fragment="requestFormFields" th:object="${request}" class="space-y-6">
          <!-- Informaci√≥n de la solicitud (readonly o inputs en modo crear) -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-gray-900 mb-3">Informaci√≥n de la Solicitud</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div>
                <span class="text-gray-500">Usuario:</span>
                <span class="ml-2 font-medium" th:unless="${isCreate}" th:text="${request.user?.username}">usuario</span>
                <select th:if="${isCreate}" name="userId"
                        class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                  <option value="" selected>Seleccionar usuario</option>
                  <option th:each="u : ${users}" th:value="${u.id}" th:text="${u.username}"></option>
                </select>
              </div>
              <div>
                <span class="text-gray-500">Fecha creaci√≥n:</span>
                <span class="ml-2" th:text="${#temporals.format(request.createdAt, 'dd/MM/yyyy HH:mm')}">fecha</span>
              </div>
              <div th:if="${isCreate}" class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Organizaci√≥n</label>
                <select name="organizationId"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                  <option value="" selected>Seleccionar organizaci√≥n</option>
                  <option th:each="o : ${organizations}" th:value="${o.id}" th:text="${o.username}"></option>
                </select>
                <p th:if="${organizations == null or #lists.isEmpty(organizations)}" class="mt-1 text-xs text-gray-500">No hay organizaciones activas registradas a√∫n.</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Direcci√≥n</label>
                <input type="text" th:field="*{collectionAddress}" placeholder="Direcci√≥n de recolecci√≥n"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"/>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha programada</label>
                <input type="date" th:field="*{scheduledDate}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"/>
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
                <textarea th:field="*{description}" rows="2" placeholder="Detalle de los residuos..."
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"></textarea>
              </div>
            </div>
          </div>

          <!-- Imagen de la solicitud -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Imagen de la Solicitud</label>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <input type="url" th:field="*{imageUrl}" placeholder="URL de imagen externa"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"/>
              </div>
              <div>
                <input type="file" name="requestImageFile" accept="image/*"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                <p class="mt-1 text-xs text-gray-500">O sube una imagen de los residuos (JPG, PNG, GIF)</p>
              </div>
            </div>
          </div>

          <!-- Campos editables -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Estado *</label>
              <select name="status" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                <option th:value="PENDING" th:selected="${request.status.name() == 'PENDING'}">Pendiente</option>
                <option th:value="ACCEPTED" th:selected="${request.status.name() == 'ACCEPTED'}">Aceptada</option>
                <option th:value="COMPLETED" th:selected="${request.status.name() == 'COMPLETED'}">Completada</option>
                <option th:value="REJECTED" th:selected="${request.status.name() == 'REJECTED'}">Rechazada</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Notas del Administrador</label>
            <textarea th:field="*{notes}" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Agregar notas sobre el estado de la solicitud..."></textarea>
          </div>
        </div>

        <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200">
          <a th:href="@{/admin/requests}" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancelar</a>
          <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700" th:text="${isCreate} ? 'Crear' : 'Actualizar'">Actualizar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg max-w-md w-full">
        <div class="p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
            </div>
            <div class="ml-3">
              <h3 class="text-lg font-medium text-gray-900">Confirmar Eliminaci√≥n</h3>
              <p class="mt-2 text-sm text-gray-500">
                ¬øEst√°s seguro de que deseas eliminar la solicitud de <strong id="deleteRequestName"></strong>?
                Esta acci√≥n no se puede deshacer.
              </p>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 px-6 py-3 flex justify-end space-x-3">
          <button onclick="closeDeleteModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancelar</button>
          <form id="deleteForm" method="post" class="inline">
            <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
            <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Eliminar</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    lucide.createIcons();
    // Paginaci√≥n front-end simple
    (function() {
      const tbody = document.getElementById('requestsTableBody');
      if (!tbody) return;
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const pageSizeSelect = document.getElementById('requestsPageSize');
      const pageInfo = document.getElementById('requestsPageInfo');
      const controls = document.getElementById('requestsPaginationControls');

      let pageSize = parseInt(localStorage.getItem('requests_page_size') || '10', 10);
      if (![10,25,50,100].includes(pageSize)) pageSize = 10;
      pageSizeSelect.value = String(pageSize);
      let currentPage = 1;

      function renderPage() {
        const total = rows.length;
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        if (currentPage > totalPages) currentPage = totalPages;
        const startIdx = (currentPage - 1) * pageSize;
        const endIdx = Math.min(startIdx + pageSize, total);

        rows.forEach((tr, idx) => {
          tr.style.display = (idx >= startIdx && idx < endIdx) ? '' : 'none';
        });

        if (total === 0) {
          pageInfo.textContent = 'Mostrando 0‚Äì0 de 0';
        } else {
          pageInfo.textContent = `Mostrando ${startIdx + 1}‚Äì${endIdx} de ${total}`;
        }

        buildControls(totalPages);
      }

      function buildControls(totalPages) {
        controls.innerHTML = '';
        const btnClass = 'px-3 py-1 border rounded-md text-sm hover:bg-gray-50';
        const activeClass = 'bg-emerald-600 text-white border-emerald-600 hover:bg-emerald-700';

        function addButton(label, disabled, onClick, extraClass = '') {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = label;
          btn.className = `${btnClass} ${extraClass}`;
          btn.disabled = disabled;
          btn.onclick = onClick;
          controls.appendChild(btn);
        }

        addButton('¬´', currentPage === 1, () => { currentPage = 1; renderPage(); });
        addButton('‚Äπ', currentPage === 1, () => { currentPage--; renderPage(); });

        const maxBtns = 7;
        let start = Math.max(1, currentPage - Math.floor(maxBtns/2));
        let end = Math.min(totalPages, start + maxBtns - 1);
        if (end - start + 1 < maxBtns) {
          start = Math.max(1, end - maxBtns + 1);
        }
        for (let p = start; p <= end; p++) {
          addButton(String(p), false, () => { currentPage = p; renderPage(); }, p === currentPage ? activeClass : '');
        }

        addButton('‚Ä∫', currentPage === totalPages, () => { currentPage++; renderPage(); });
        addButton('¬ª', currentPage === totalPages, () => { currentPage = totalPages; renderPage(); });
      }

      pageSizeSelect.addEventListener('change', () => {
        pageSize = parseInt(pageSizeSelect.value, 10);
        localStorage.setItem('requests_page_size', String(pageSize));
        currentPage = 1;
        renderPage();
      });

      renderPage();
    })();

    function confirmDelete(button) {
      const id = button.getAttribute('data-id');
      const name = button.getAttribute('data-name');
      document.getElementById('deleteRequestName').textContent = name || 'este usuario';
      const form = document.getElementById('deleteForm');
      form.action = '/admin/requests/delete/' + id;
      document.getElementById('deleteModal').classList.remove('hidden');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.add('hidden');
    }

    document.getElementById('deleteModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeDeleteModal();
      }
    });
  </script>
 </main>
 </body>
 </html>

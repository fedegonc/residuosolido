<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/admin-layout :: head('Editar Post')}"></head>
<body th:replace="~{fragments/admin-layout :: layout(~{::content})}">
    <div th:fragment="content">
        <!-- Encabezado simple -->
        <div class="bg-gray-50 py-8">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-900">Editar Post</h1>
                </div>
            </div>
        </div>

        <!-- Contenido principal -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            
            <!-- Formulario de edición -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-6">
                    <form th:action="@{/admin/posts/{id}/edit(id=${post.id})}" method="post" class="space-y-4" id="editPostForm">
                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-700">Título</label>
                            <input type="text" name="title" id="title" th:value="${post.title}" required 
                                   class="mt-1 w-full px-3 py-2 border rounded-lg">
                        </div>
                        
                        <div>
                            <label for="content" class="block text-sm font-medium text-gray-700">Contenido</label>
                            <textarea name="content" id="content" required 
                                      class="mt-1 w-full px-3 py-2 border rounded-lg h-32" th:text="${post.content}"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Imagen Actual</label>
                            <div th:if="${post.imageUrl != null and !post.imageUrl.isEmpty()}" class="mb-4">
                                <img th:src="${post.imageUrl}" alt="Imagen actual" class="w-48 h-32 object-cover rounded-lg border">
                                <p class="text-sm text-gray-500 mt-1">Imagen actual del post</p>
                            </div>
                            <div th:if="${post.imageUrl == null or post.imageUrl.isEmpty()}" class="mb-4">
                                <div class="w-48 h-32 bg-gray-100 rounded-lg border flex items-center justify-center">
                                    <span class="text-gray-400 text-sm">Sin imagen</span>
                                </div>
                            </div>
                            
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cambiar Imagen</label>
                            <input type="file" id="editImageFile" accept="image/*" 
                                   class="w-full px-3 py-2 border rounded-lg">
                            <input type="hidden" name="imageUrl" id="editImageUrlHidden" th:value="${post.imageUrl != null ? post.imageUrl : ''}">
                            <div id="editImagePreview" class="mt-2 hidden">
                                <img id="editPreviewImg" class="w-48 h-32 object-cover rounded-lg border">
                                <p class="text-sm text-gray-500 mt-1">Nueva imagen seleccionada</p>
                            </div>
                            <div id="editUploadStatus" class="mt-2 text-sm"></div>
                            <p class="mt-1 text-sm text-gray-500">Selecciona una nueva imagen para cambiar la actual</p>
                        </div>
                        
                        <div>
                            <label for="categoryId" class="block text-sm font-medium text-gray-700">Categoría</label>
                            <select name="categoryId" id="categoryId" required class="mt-1 w-full px-3 py-2 border rounded-lg">
                                <option value="">Seleccionar categoría</option>
                                <option th:each="cat : ${categories}" 
                                        th:value="${cat.id}" 
                                        th:text="${cat.name}"
                                        th:selected="${cat.id == post.categoryId}">Categoría</option>
                            </select>
                        </div>
                        
                        <div class="flex justify-between pt-4">
                            <a th:href="@{/admin/posts}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Cancelar
                            </a>
                            <button type="submit" 
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700">
                                Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const imageInput = document.getElementById('editImageFile');
        const imagePreview = document.getElementById('editImagePreview');
        const previewImg = document.getElementById('editPreviewImg');
        const uploadStatus = document.getElementById('editUploadStatus');
        const imageUrlHidden = document.getElementById('editImageUrlHidden');
        const form = document.getElementById('editPostForm');
        
        // Preview de imagen
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.classList.add('hidden');
            }
        });
        
        // Manejar envío del formulario
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const imageFile = imageInput.files[0];
            
            try {
                // Subir imagen a Cloudinary si se seleccionó una nueva
                if (imageFile) {
                    uploadStatus.textContent = 'Subiendo nueva imagen...';
                    uploadStatus.className = 'mt-2 text-sm text-blue-600';
                    
                    const imageFormData = new FormData();
                    imageFormData.append('image', imageFile);
                    
                    const imageResponse = await fetch('/admin/upload-image', {
                        method: 'POST',
                        body: imageFormData
                    });
                    
                    if (imageResponse.ok) {
                        const imageUrl = await imageResponse.text();
                        imageUrlHidden.value = imageUrl;
                        uploadStatus.textContent = 'Nueva imagen subida exitosamente';
                        uploadStatus.className = 'mt-2 text-sm text-green-600';
                    } else {
                        const errorText = await imageResponse.text();
                        uploadStatus.textContent = 'Error: ' + errorText;
                        uploadStatus.className = 'mt-2 text-sm text-red-600';
                        return;
                    }
                } else {
                    // Si no hay nueva imagen, mantener la actual o vacío
                    uploadStatus.textContent = 'Manteniendo imagen actual...';
                    uploadStatus.className = 'mt-2 text-sm text-gray-600';
                }
                
                // Enviar formulario
                uploadStatus.textContent = 'Actualizando post...';
                uploadStatus.className = 'mt-2 text-sm text-blue-600';
                
                // Pequeña pausa para mostrar el mensaje
                setTimeout(() => {
                    form.submit();
                }, 500);
                
            } catch (error) {
                console.error('Error:', error);
                uploadStatus.textContent = 'Error al procesar la solicitud';
                uploadStatus.className = 'mt-2 text-sm text-red-600';
            }
        });
    });
    </script>
</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<!-- LOCATION SELECTOR COMPONENT -->
<div th:fragment="location-selector(latitude, longitude, address)">
    <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Ubicación</label>
        
        <!-- Campos ocultos para coordenadas -->
        <input type="hidden" id="latitude" name="latitude" th:value="${latitude}">
        <input type="hidden" id="longitude" name="longitude" th:value="${longitude}">
        
        <!-- Campo de dirección -->
        <div class="mb-3">
            <input type="text" id="address" name="address" 
                   th:value="${address}"
                   placeholder="Ingrese dirección o haga clic en el mapa"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
        </div>
        
        <!-- Mapa -->
        <div id="map" class="w-full h-64 border border-gray-300 rounded-md"></div>
        
        <!-- Información de coordenadas -->
        <div class="mt-2 text-sm text-gray-600">
            <span id="coordinates-info">
                <span th:if="${latitude != null and longitude != null}">
                    Coordenadas: <span th:text="${latitude}"></span>, <span th:text="${longitude}"></span>
                </span>
                <span th:if="${latitude == null or longitude == null}">
                    Haga clic en el mapa para seleccionar ubicación
                </span>
            </span>
        </div>
    </div>
</div>

<!-- CSS para el mapa -->
<style th:fragment="location-selector-css">
    .leaflet-container {
        height: 100%;
        width: 100%;
    }
    
    .custom-marker {
        background-color: #10b981;
        border: 2px solid white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
</style>

<!-- JavaScript para el mapa -->
<script th:fragment="location-selector-js">
    let map;
    let marker;
    
    function initLocationSelector() {
        // Coordenadas por defecto (Rivera, Uruguay)
        const defaultLat = -30.9054;
        const defaultLng = -55.5511;
        
        // Obtener coordenadas actuales si existen
        const currentLat = document.getElementById('latitude').value || defaultLat;
        const currentLng = document.getElementById('longitude').value || defaultLng;
        
        // Inicializar mapa
        map = L.map('map').setView([currentLat, currentLng], 13);
        
        // Agregar tiles de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Agregar marcador si hay coordenadas
        if (document.getElementById('latitude').value && document.getElementById('longitude').value) {
            addMarker(currentLat, currentLng);
        }
        
        // Event listener para clics en el mapa
        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            // Actualizar campos ocultos
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            
            // Actualizar información de coordenadas
            document.getElementById('coordinates-info').innerHTML = 
                `Coordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            
            // Agregar/mover marcador
            addMarker(lat, lng);
            
            // Obtener dirección usando geocodificación inversa
            reverseGeocode(lat, lng);
        });
        
        // Event listener para el campo de dirección
        document.getElementById('address').addEventListener('blur', function() {
            const address = this.value;
            if (address.trim()) {
                geocodeAddress(address);
            }
        });
    }
    
    function addMarker(lat, lng) {
        // Remover marcador existente
        if (marker) {
            map.removeLayer(marker);
        }
        
        // Agregar nuevo marcador
        marker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'custom-marker',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            })
        }).addTo(map);
        
        // Centrar mapa en el marcador
        map.setView([lat, lng], map.getZoom());
    }
    
    function reverseGeocode(lat, lng) {
        // Usar servicio de geocodificación inversa de Nominatim
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`)
            .then(response => response.json())
            .then(data => {
                if (data && data.display_name) {
                    document.getElementById('address').value = data.display_name;
                }
            })
            .catch(error => {
                console.log('Error en geocodificación inversa:', error);
            });
    }
    
    function geocodeAddress(address) {
        // Usar servicio de geocodificación de Nominatim
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);
                    
                    // Actualizar campos
                    document.getElementById('latitude').value = lat;
                    document.getElementById('longitude').value = lng;
                    document.getElementById('coordinates-info').innerHTML = 
                        `Coordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    
                    // Agregar marcador y centrar mapa
                    addMarker(lat, lng);
                }
            })
            .catch(error => {
                console.log('Error en geocodificación:', error);
            });
    }
    
    // Inicializar cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
        // Verificar si Leaflet está disponible
        if (typeof L !== 'undefined') {
            initLocationSelector();
        } else {
            console.error('Leaflet no está cargado');
        }
    });
</script>

</body>
</html>

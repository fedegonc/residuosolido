<!-- Fragmento: Lista de Organizaciones -->
<div th:fragment="organizationsList" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H9m0 0H5m0 0h2M7 8h3v8H7V8z"></path>
            </svg>
            <span th:text="#{organizations.title}">Organizaciones</span>
        </h2>

        <div class="space-y-4">
            <!-- Organizaciones dinámicas -->
            <div th:if="${organizations != null and !organizations.isEmpty()}">
                <div th:each="org : ${organizations}" class="border border-gray-200 rounded-lg p-5 hover:bg-blue-50 hover:border-blue-200 transition-all duration-200">
                    <!-- Nombre de la organización -->
                    <h3 class="font-semibold text-gray-900 text-lg mb-3" 
                        th:text="${org.firstName != null and org.lastName != null ? org.firstName + ' ' + org.lastName : org.username}">
                        Nombre Organización
                    </h3>
                    
                    <!-- Ubicación/Dirección -->
                    <div class="mb-3">
                        <p class="text-sm text-gray-600 flex items-center">
                            <svg class="w-4 h-4 text-gray-400 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <span th:text="${(org.direccion != null and !#strings.isEmpty(org.direccion)) ? org.direccion : (org.address != null and !#strings.isEmpty(org.address)) ? org.address : 'Barrio Centro (Rivera)'}">
                                Barrio Centro (Rivera)
                            </span>
                        </p>
                    </div>

                    <!-- Email de contacto -->
                    <div class="mb-3">
                        <p class="text-sm text-gray-600 flex items-center">
                            <svg class="w-4 h-4 text-gray-400 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            <span th:text="${org.email != null and !#strings.isEmpty(org.email) ? org.email : 'contacto@organizacion.com'}">
                                contacto@organizacion.com
                            </span>
                        </p>
                    </div>

                    <!-- Materiales que recibe -->
                    <div class="mb-4">
                        <p class="text-sm font-medium text-gray-700 mb-2">Materiales que recibe:</p>
                        <div class="flex flex-wrap gap-1.5">
                            <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 border border-green-200">Plástico</span>
                            <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800 border border-blue-200">Papel</span>
                            <span class="px-2 py-1 text-xs rounded-full bg-amber-100 text-amber-800 border border-amber-200">Cartón</span>
                            <span class="px-2 py-1 text-xs rounded-full bg-emerald-100 text-emerald-800 border border-emerald-200">Vidrio</span>
                            <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800 border border-gray-200">Metales</span>
                        </div>
                    </div>
                    
                    <!-- Mapa -->
                    <div th:if="${(org.latitude != null or org.latitud != null) and (org.longitude != null or org.longitud != null)}"
                         th:id="'orgMap-' + ${org.id}"
                         class="w-full rounded-lg border border-gray-300 bg-gray-50"
                         style="height:140px; min-height:140px;"
                         th:data-lat="${org.latitude != null ? org.latitude : org.latitud}"
                         th:data-lng="${org.longitude != null ? org.longitude : org.longitud}"
                         th:data-name="${org.firstName != null and org.lastName != null ? org.firstName + ' ' + org.lastName : org.username}">
                    </div>
                    <div th:if="${(org.latitude == null and org.latitud == null) or (org.longitude == null and org.longitud == null)}" 
                         class="w-full h-20 bg-gray-100 rounded-lg flex items-center justify-center border border-gray-200">
                        <div class="text-center">
                            <svg class="w-6 h-6 mx-auto mb-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <p class="text-xs text-gray-500">Ubicación no disponible</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mensaje si no hay organizaciones -->
            <div th:if="${organizations == null or organizations.isEmpty()}" class="text-center py-12 text-gray-500">
                <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H9m0 0H5m0 0h2M7 8h3v8H7V8z"></path>
                </svg>
                <p class="text-base font-medium text-gray-600 mb-1">No hay organizaciones registradas</p>
                <p class="text-sm text-gray-500">Las organizaciones aparecerán aquí cuando se registren</p>
            </div>
        </div>
        <!-- Assets y script para mapas (auto-contenido del fragmento) -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script>
        (function(){
            function initSingleMap(node){
                if (!node || node.__mapInitialized) return;
                var lat = parseFloat(node.getAttribute('data-lat'));
                var lng = parseFloat(node.getAttribute('data-lng'));
                var name = node.getAttribute('data-name') || 'Organización';
                if (isNaN(lat) || isNaN(lng)) return;
                // Crear mapa y marcador
                var map = L.map(node, { zoomControl: false, attributionControl: false }).setView([lat, lng], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
                L.marker([lat, lng]).addTo(map).bindPopup(name);
                // Ajuste de tamaño pos-render
                setTimeout(function(){ map.invalidateSize(); }, 100);
                node.__mapInitialized = true;
            }

            function observeMaps(){
                var nodes = document.querySelectorAll('[id^="orgMap-"]');
                if (!('IntersectionObserver' in window)) {
                    // Fallback: inicializar los visibles tras pequeño delay
                    setTimeout(function(){ nodes.forEach(initSingleMap); }, 0);
                    return;
                }
                var obs = new IntersectionObserver(function(entries){
                    entries.forEach(function(entry){
                        if (entry.isIntersecting) {
                            initSingleMap(entry.target);
                            obs.unobserve(entry.target);
                        }
                    });
                }, { root: null, rootMargin: '0px 0px 200px 0px', threshold: 0.01 });
                nodes.forEach(function(n){ obs.observe(n); });
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', observeMaps);
            } else {
                observeMaps();
            }
        })();
        </script>
    </div>
<!-- Fin fragmento -->

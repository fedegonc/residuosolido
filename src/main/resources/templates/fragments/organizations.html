<!-- Fragmento: Lista de Organizaciones -->
<div th:fragment="organizationsList" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H9m0 0H5m0 0h2M7 8h3v8H7V8z"></path>
            </svg>
            Organizaciones
        </h2>

        <div class="space-y-4">
            <!-- Organizaciones dinámicas -->
            <div th:if="${organizations != null and !organizations.isEmpty()}">
                <div th:each="org : ${organizations}" class="border border-gray-200 rounded-lg p-6 hover:bg-blue-50 hover:border-blue-200 transition-all duration-200">
                    <!-- Nombre -->
                    <h3 class="font-semibold text-gray-900 text-lg mb-2" th:text="${org.firstName + ' ' + org.lastName}">Nombre Organización</h3>
                    
                    <!-- Dirección -->
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 flex items-center">
                            <svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <span th:text="${org.direccion != null ? org.direccion : 'Dirección no especificada'}">Dirección</span>
                        </p>
                    </div>
                    
                    <!-- Info adicional (hardcoded) -->
                    <div class="mb-4 space-y-2">
                        <!-- Zona/Barrio -->
                        <p class="text-sm text-gray-600 flex items-center">
                            <svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c1.657 0 3-1.343 3-3S13.657 5 12 5 9 6.343 9 8s1.343 3 3 3z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.341A8 8 0 104.572 15.34L12 21l7.428-5.659z"></path>
                            </svg>
                            Zona: Barrio Centro (Rivera)
                        </p>

                        <!-- Materiales que recibe -->
                        <div>
                            <p class="text-sm font-medium text-gray-700 mb-1">Materiales que recibe</p>
                            <div class="flex flex-wrap gap-2">
                                <span class="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-800 border border-green-200">Plástico</span>
                                <span class="px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-800 border border-blue-200">Papel</span>
                                <span class="px-2 py-0.5 text-xs rounded-full bg-amber-100 text-amber-800 border border-amber-200">Cartón</span>
                                <span class="px-2 py-0.5 text-xs rounded-full bg-emerald-100 text-emerald-800 border border-emerald-200">Vidrio</span>
                                <span class="px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-800 border border-gray-200">Metales</span>
                            </div>
                        </div>

                        <!-- Contacto -->
                        <p class="text-sm text-gray-600 flex items-center">
                            <svg class="w-4 h-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.129a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.492 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                            </svg>
                            Tel: 098 123 456
                        </p>
                    </div>
                    
                    <!-- Mapa -->
                    <div th:if="${(org.latitude != null or org.latitud != null) and (org.longitude != null or org.longitud != null)}"
                         th:id="'orgMap-' + ${org.id}"
                         class="w-full rounded-lg border border-gray-300"
                         style="height:200px; min-height:200px;"
                         th:data-lat="${org.latitude != null ? org.latitude : org.latitud}"
                         th:data-lng="${org.longitude != null ? org.longitude : org.longitud}"
                         th:data-name="${org.firstName + ' ' + org.lastName}">
                    </div>
                    <div th:if="${(org.latitude == null and org.latitud == null) or (org.longitude == null and org.longitud == null)}" class="w-full h-32 bg-gray-100 rounded-lg flex items-center justify-center">
                        <p class="text-sm text-gray-500">Ubicación no disponible</p>
                    </div>
                </div>
            </div>
            
            <!-- Mensaje si no hay organizaciones -->
            <div th:if="${organizations == null or organizations.isEmpty()}" class="text-center py-8 text-gray-500">
                <svg class="w-8 h-8 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H9m0 0H5m0 0h2M7 8h3v8H7V8z"></path>
                </svg>
                <p class="text-sm mb-2">No hay organizaciones</p>
                <p class="text-xs">Registradas aún</p>
            </div>
        </div>
        <!-- Assets y script para mapas (auto-contenido del fragmento) -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script>
        (function(){
            function initSingleMap(node){
                if (!node || node.__mapInitialized) return;
                var lat = parseFloat(node.getAttribute('data-lat'));
                var lng = parseFloat(node.getAttribute('data-lng'));
                var name = node.getAttribute('data-name') || 'Organización';
                if (isNaN(lat) || isNaN(lng)) return;
                // Crear mapa y marcador
                var map = L.map(node, { zoomControl: false, attributionControl: false }).setView([lat, lng], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
                L.marker([lat, lng]).addTo(map).bindPopup(name);
                // Ajuste de tamaño pos-render
                setTimeout(function(){ map.invalidateSize(); }, 100);
                node.__mapInitialized = true;
            }

            function observeMaps(){
                var nodes = document.querySelectorAll('[id^="orgMap-"]');
                if (!('IntersectionObserver' in window)) {
                    // Fallback: inicializar los visibles tras pequeño delay
                    setTimeout(function(){ nodes.forEach(initSingleMap); }, 0);
                    return;
                }
                var obs = new IntersectionObserver(function(entries){
                    entries.forEach(function(entry){
                        if (entry.isIntersecting) {
                            initSingleMap(entry.target);
                            obs.unobserve(entry.target);
                        }
                    });
                }, { root: null, rootMargin: '0px 0px 200px 0px', threshold: 0.01 });
                nodes.forEach(function(n){ obs.observe(n); });
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', observeMaps);
            } else {
                observeMaps();
            }
        })();
        </script>
    </div>
<!-- Fin fragmento -->
